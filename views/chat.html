{% include "layout.html" %}

{% include "title.html" %}

{% include "navbar.html" %}


    <div id="chat">
        <div class='chat-container'>
            <div class="chat-interface">
                {% for msg in messages %}
                <div class="messageContainer">
                    <p class="date">{{msg.author}}</p>
                    <p class="message">
                        {{ msg.content }}
                    </p>
                </div>                
                {% endfor %}
            </div>
            <div class="bottom-chat">
                <input type="textfield" id="message-content">
                <button type="submit" id="sendMsg">Envoyer</button>
            </div>
        </div>
    </div>
{% include "footer.html" %}

<script>

    // Initialises SOCKET.IO connection
    const socket = io()
    // Once connected, the event is triggered 
    socket.on('connect', () => {
        console.log('connected !')
        // Send the event to the server
        socket.emit('event-name', { ladata: 'bonjour' })
    })
    

    function displayMessage(htmlMessage) {
        document.querySelector(".chat-interface").innerHTML += htmlMessage
    }

    window.addEventListener('load', function () {

        let testinterface = document.querySelector(".chat-interface")
        testinterface.scrollTop = testinterface.scrollHeight
        let inputMsg = document.getElementById('message-content')


        inputMsg.addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                document.querySelector("#sendMsg").click();
            }
        });

        document.querySelector("#sendMsg").addEventListener("click", ()=>{
            var cookieUser = document.cookie
            const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('pseudo='))
            .split('=')[1];
            console.log(cookieUser);

            console.log("cookie : " + cookieValue);
            let content = inputMsg.value
            inputMsg.value = ""
            socket.emit('message-sent', { data: content, cookieValue })

        })

        socket.on('messageRegistered', data => {
            console.log(' la data :' + data)
            console.log(data.message)
            console.log(data.pseudo)
            document.querySelector(".chat-interface").innerHTML += data.pseudo + ' : ' + data.  message + '<br>'
            let testinterface = document.querySelector(".chat-interface")
            testinterface.scrollTop = testinterface.scrollHeight
            data = ""
        })
    })

    
</script>
